
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>^memory^blog</title>
  <meta name="author" content="John Woffindin">

  
  <meta name="description" content="Diclaimer: This post is a work in progress. It&rsquo;s disorganised and any
commands presented below are likey to destroy your production database, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jwoffindin.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="^memory^blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">^memory^blog</a></h1>
  
    <h2>Document it so I don't have to remember it</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jwoffindin.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/vim-shortcuts">VIM Shortcuts</a></li>
  <li><a href="/cv-john-woffindin">My Resume</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/20/migrating-aws-images-between-regions/">Migrating a AWS VPC Between Regions - Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-20T10:10:00+12:00" pubdate data-updated="true">Aug 20<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>Diclaimer: This post is a work in progress. It&rsquo;s disorganised and any
commands presented below are likey to destroy your production database,
so take the following with a large grain of salt</strong></p>

<p>This is first part of a series that describes the process I went through
migrating AWS-based VPC instances from US region to AU and using
CloudFormation for setting up VPC. It is also an excuse to finally start
a blog and kick the tires of <a href="http://octopress.org/">Octopress</a>.</p>

<h2>Background</h2>

<p>We have two VPC networks on AWS with servers split across several
subnets. OS is Oracle Enterprise Linux 5.5. The original AMIs are no
longer provided by Oracle, and there are no corresponding Kernel (AKI)
or Ramdisk Image (ARI) in the <code>ap-southeast-2</code> region, so using AWS EC2
Copy [does not work][1].</p>

<p>Fortunately the target region supports <a href="http://wiki.xen.org/wiki/PvGrub">pv-grub</a> so the migration will
will also include making migrated server bootable via pv-grub.</p>

<p>So, the plan is to:</p>

<ol>
<li>Write script to copy root and data EBS volumes to the &ldquo;target&rdquo;
region.</li>
<li>Update these copied root volumes to make then bootable under pv-grub
the target region. Each server has an unknown set of changes made so
we must migrate all instances.</li>
<li>Create a CloudFormation template referencing migrated AMIs so
instances are created in the correct subnets and correct data volumes
are mounted on the correct hosts.</li>
<li>Create the server instances using CloudFormation and test</li>
<li>Clean up after ourselves.</li>
</ol>


<p>The first step is straight forward so I&rsquo;ll cover it here. The remaining
activities will be covered in their own posts.</p>

<h2>Migrating Root Images</h2>

<p>Each of the instances has two EBS volumes &ndash; a <em>system</em> EBS volume
(containing the root and boot partitions) and a <em>data</em> volume. The
system volume is a disk image with 3 parititons:</p>

<ul>
<li><code>/dev/sda1</code> &ndash; the <code>/boot</code> volume</li>
<li><code>/dev/sda1</code> &ndash; the root volume (mounted as &lsquo;/&rsquo;)</li>
<li><code>/dev/sda3</code> &ndash; swap (more on this one later)</li>
</ul>


<p>Below is a simple ZSH script I wrote to migrate root EBS
volumes from one region to another. It sputs out a CSV file
which we&rsquo;ll need later to correlate the migrated instances against the
original instance ids.</p>

<div><script src='https://gist.github.com/6373731.js'></script>
<noscript><pre><code></code></pre></noscript></div>


<p>The current version only migrates the root images, will update later
with something a bit smarter.</p>

<p>Note that snapshotting the filesystems is a bit tricky since the OREL 5.5
systems aren&rsquo;t using LVM and don&rsquo;t support [fsfreeze].
As a workaround, the script will remount the root filesystem read-only,
trigger ec2 snapshot and then remount as writeable. The issue is that we
are not handling application consistency correctly (e.g. databases).</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/08/20/migrating-aws-images-between-regions/">Migrating a AWS VPC Between Regions - Part 1</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jwoffindin">@jwoffindin</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jwoffindin',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>



<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/j.woffindin@gmail.om?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - John Woffindin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
